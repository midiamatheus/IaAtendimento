<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beaver CS Â· Assistente</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--beaver:#7B3FE4;--beaver-light:#9B6FF0;--beaver-dark:#5A2DB0;--cream:#FAF8F5;--ink:#1A1025;--ink-soft:#3D2E52;--mist:#EDE8F7;--mist-deep:#D9D0F0;--green:#2DCB85;--amber:#F0A500;--red:#E84040;--border:rgba(123,63,228,0.12)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--cream);height:100vh;display:flex;flex-direction:column;font-size:14px;overflow:hidden}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:var(--ink);border-bottom:2px solid var(--beaver)}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:30px;height:30px;background:var(--beaver);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:#fff}
.logo-text span{color:var(--beaver-light)}
.badge{display:flex;align-items:center;gap:6px;background:rgba(45,203,133,0.15);border:1px solid rgba(45,203,133,0.3);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:500;color:var(--green)}
.pulse{width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.tab-bar{display:flex;background:var(--ink);border-bottom:1px solid rgba(123,63,228,0.2);padding-left:24px;flex-shrink:0}
.tab{padding:10px 20px;font-size:12.5px;cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;transition:all .15s;border-bottom:2px solid transparent;color:rgba(255,255,255,0.45);font-weight:400}
.tab.active{font-weight:600;color:#fff;border-bottom-color:var(--beaver)}
.main{display:flex;flex:1;overflow:hidden;min-height:0}
aside{width:250px;background:var(--ink);border-right:1px solid rgba(123,63,228,0.2);display:flex;flex-direction:column;overflow-y:auto;padding:18px 13px;gap:16px;flex-shrink:0}
.side-title{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);padding-left:3px;margin-bottom:6px}
.quick-btn{width:100%;text-align:left;background:rgba(255,255,255,0.04);border:1px solid rgba(123,63,228,0.15);border-radius:9px;padding:9px 10px;color:rgba(255,255,255,0.72);font-family:'DM Sans',sans-serif;font-size:11.5px;cursor:pointer;line-height:1.4;margin-bottom:4px;display:flex;align-items:flex-start;gap:7px;transition:all .15s}
.quick-btn:hover{background:rgba(123,63,228,0.14);border-color:var(--beaver);color:#fff;transform:translateX(3px)}
.divider{border:none;border-top:1px solid rgba(255,255,255,0.06);margin:8px 0}
.tone-btn{display:flex;align-items:center;gap:7px;padding:7px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.07);background:transparent;cursor:pointer;color:rgba(255,255,255,0.55);font-size:11.5px;margin-bottom:4px;width:100%;text-align:left;font-family:'DM Sans',sans-serif;transition:all .15s}
.tone-btn.active{border-color:var(--beaver);background:rgba(123,63,228,0.15);color:#fff}
.kb-text{font-size:11px;color:rgba(255,255,255,0.38);line-height:1.8;padding-left:3px}
#content{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}
.chat-area{display:flex;flex-direction:column;height:100%;overflow:hidden}
.msgs{flex:1;overflow-y:scroll !important;overflow-x:hidden;padding:22px 26px;display:flex;flex-direction:column;gap:18px}
.welcome-card{background:linear-gradient(135deg,var(--beaver) 0%,var(--beaver-dark) 100%);border-radius:16px;padding:20px 24px;color:#fff}
.welcome-card h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:5px}
.welcome-card p{font-size:13px;opacity:.85;line-height:1.5}
.msg-row{display:flex;align-items:flex-start;gap:9px;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg-row.user{flex-direction:row-reverse}
.avatar{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;background:var(--beaver);color:#fff;font-weight:700;font-family:'Syne',sans-serif}
.user .avatar{background:var(--ink);font-size:10px}
.msg-content{max-width:65%;word-wrap:break-word;overflow-wrap:break-word}
.msg-label{font-size:9.5px;font-weight:600;letter-spacing:.5px;color:rgba(26,16,37,0.35);text-transform:uppercase;padding-left:2px;margin-bottom:3px}
.user-bubble{background:var(--beaver);border-radius:13px;border-top-right-radius:3px;padding:10px 14px;font-size:13.5px;line-height:1.6;color:#fff;word-wrap:break-word;overflow-wrap:break-word}
.response-wrap{display:flex;flex-direction:column;gap:7px;max-width:65%;word-wrap:break-word;overflow-wrap:break-word}
.block-internal{background:#fff;border:1px solid var(--border);border-left:3px solid var(--amber);border-radius:12px;border-top-left-radius:3px;padding:11px 14px;font-size:12.5px;line-height:1.6;color:var(--ink-soft);word-wrap:break-word;overflow-wrap:break-word}
.block-label{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:4px}
.block-label.amber{color:var(--amber)}
.block-label.beaver{color:var(--beaver)}
.block-msg{background:var(--mist);border:1.5px solid var(--beaver);border-radius:12px;border-top-left-radius:3px;padding:13px 15px;word-wrap:break-word;overflow-wrap:break-word}
.block-msg-text{white-space:pre-wrap;font-size:13.5px;line-height:1.65;color:var(--ink);border-left:3px solid var(--beaver-light);padding-left:11px;margin-top:2px;word-wrap:break-word;overflow-wrap:break-word}
.actions-row{display:flex;gap:5px;flex-wrap:wrap;margin-top:4px}
.copy-btn{background:none;border:1px solid var(--border);border-radius:7px;padding:3px 10px;font-size:10.5px;color:var(--beaver);cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:500;display:flex;align-items:center;gap:3px;transition:all .15s}
.copy-btn:hover{background:var(--mist);border-color:var(--beaver)}
.copy-btn.copied{background:rgba(45,203,133,0.08);border-color:var(--green);color:var(--green)}
.typing-dots{display:flex;gap:5px;padding:11px 14px;background:#fff;border:1px solid var(--border);border-radius:13px;border-top-left-radius:3px}
.typing-dots span{width:7px;height:7px;border-radius:50%;background:var(--beaver-light);animation:bounce 1.2s infinite}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
.input-area{padding:14px 26px 18px;border-top:1px solid var(--border);background:var(--cream);flex-shrink:0}
.input-wrapper{background:#fff;border:1.5px solid var(--border);border-radius:13px;display:flex;flex-direction:column;box-shadow:0 3px 16px rgba(123,63,228,0.07)}
.input-wrapper:focus-within{border-color:var(--beaver);box-shadow:0 3px 16px rgba(123,63,228,0.15)}
.input-meta{display:flex;align-items:center;gap:8px;padding:9px 13px 0}
.input-meta-label{font-size:10px;font-weight:600;color:rgba(26,16,37,0.35);text-transform:uppercase;letter-spacing:.8px}
.client-input{border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:12.5px;font-weight:500;color:var(--beaver);background:transparent;width:150px}
.textarea{border:none;outline:none;resize:none;font-family:'DM Sans',sans-serif;font-size:13.5px;line-height:1.6;color:var(--ink);padding:9px 13px;background:transparent;min-height:60px;max-height:130px}
.input-footer{display:flex;align-items:center;justify-content:space-between;padding:6px 12px 9px}
.hint{font-size:11px;color:rgba(26,16,37,0.27)}
.send-btn{background:var(--beaver);color:#fff;border:none;border-radius:9px;padding:8px 17px;font-family:'Syne',sans-serif;font-size:12.5px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s}
.send-btn:hover{background:var(--beaver-dark)}
.send-btn:disabled{opacity:.5;cursor:not-allowed}
.error-bubble{background:#fff;border:1px solid var(--border);border-left:3px solid var(--red);border-radius:13px;padding:11px 14px;font-size:13px;color:#c0392b;max-width:65%;word-wrap:break-word}
.report-area{flex:1;overflow-y:auto;padding:22px 26px;display:flex;flex-direction:column;gap:16px}
.upload-card{background:#fff;border:2px dashed var(--mist-deep);border-radius:16px;padding:28px 24px;display:flex;flex-direction:column;align-items:center;gap:12px;cursor:pointer;transition:all .2s;text-align:center}
.upload-card:hover{border-color:var(--beaver);background:var(--mist)}
.upload-icon{font-size:36px;margin-bottom:4px}
.upload-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--ink)}
.upload-sub{font-size:12.5px;color:rgba(26,16,37,0.45);line-height:1.5}
.file-preview{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 15px;display:flex;align-items:center;gap:12px}
.file-name{font-size:13px;font-weight:500;color:var(--ink);flex:1}
.remove-btn{background:none;border:1px solid rgba(232,64,64,0.3);border-radius:6px;padding:3px 9px;font-size:11px;color:var(--red);cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s}
.remove-btn:hover{background:rgba(232,64,64,0.08)}
.context-row{display:flex;gap:10px}
.context-input{flex:1;border:1px solid var(--border);border-radius:10px;padding:9px 13px;font-size:13px;font-family:'DM Sans',sans-serif;color:var(--ink);outline:none;background:#fff}
.context-input:focus{border-color:var(--beaver)}
.analyze-btn{background:var(--beaver);color:#fff;border:none;border-radius:10px;padding:9px 20px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .15s}
.analyze-btn:hover{background:var(--beaver-dark)}
.analyze-btn:disabled{opacity:.5;cursor:not-allowed}
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-track{background:rgba(237,232,247,0.3)}
::-webkit-scrollbar-thumb{background:var(--mist-deep);border-radius:10px;border:2px solid var(--cream)}
::-webkit-scrollbar-thumb:hover{background:#C4B8E3}
textarea::placeholder,input::placeholder{color:rgba(26,16,37,0.28)}
.hidden{display:none!important}
</style>
</head>
<body>

<header>
<div class="logo">
<div class="logo-icon">ğŸ¦«</div>
<div class="logo-text">Beaver <span>CS Â· IA</span></div>
</div>
<div class="badge"><div class="pulse"></div>IA ativa</div>
</header>

<div class="tab-bar">
<button class="tab active" onclick="switchTab('cs')">ğŸ’¬ Atendimento ao Cliente</button>
<button class="tab" onclick="switchTab('report')">ğŸ“Š AnÃ¡lise de RelatÃ³rios</button>
</div>

<div class="main">
<aside id="sidebar"></aside>
<div id="content"></div>
</div>

<script>
let activeTab='cs',tone='padrao',loading=false,reportFile=null;

function switchTab(tab){activeTab=tab;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));event.target.classList.add('active');renderTab()}

function renderTab(){
  const sidebar=document.getElementById('sidebar');
  const content=document.getElementById('content');
  
  if(activeTab==='cs'){
    sidebar.innerHTML=`
      <div><div class="side-title">Atalhos rÃ¡pidos</div>
      <button class="quick-btn" onclick="sendQuick('O cliente quer saber o status de aprovaÃ§Ã£o no iClips.')"><span>ğŸ“‹</span><span>AprovaÃ§Ã£o pendente</span></button>
      <button class="quick-btn" onclick="sendQuick('Confirmar gravaÃ§Ã£o amanhÃ£.')"><span>ğŸ¬</span><span>Confirmar gravaÃ§Ã£o</span></button>
      <button class="quick-btn" onclick="sendQuick('Cliente insatisfeito.')"><span>âš ï¸</span><span>GestÃ£o de crise</span></button>
      <button class="quick-btn" onclick="sendQuick('Novo cliente assinou.')"><span>ğŸš€</span><span>Onboarding</span></button>
      <button class="quick-btn" onclick="sendQuick('Calcular orÃ§amento: fornecedor R$ 800.')"><span>ğŸ’°</span><span>OrÃ§amento</span></button>
      </div><hr class="divider">
      <div><div class="side-title">Tom da resposta</div>
      <button class="tone-btn active" onclick="setTone('padrao',this)">ğŸ’œ PadrÃ£o Beaver</button>
      <button class="tone-btn" onclick="setTone('formal',this)">ğŸ© Formal</button>
      <button class="tone-btn" onclick="setTone('direto',this)">âš¡ Direto</button>
      </div>`;
    
    content.innerHTML=`
      <div class="chat-area">
        <div class="msgs" id="msgs">
          <div class="welcome-card"><h2>OlÃ¡, equipe Beaver! ğŸ’œ</h2><p>Assistente seguindo a Persona Beaver oficial. Descrevo situaÃ§Ãµes e gero orientaÃ§Ã£o + mensagem no padrÃ£o da agÃªncia.</p></div>
        </div>
        <div class="input-area">
          <div class="input-wrapper">
            <div class="input-meta"><span class="input-meta-label">Cliente:</span><input type="text" class="client-input" id="clientName" placeholder="Nome (opcional)"></div>
            <textarea class="textarea" id="userInput" placeholder="Descreva a situaÃ§Ã£o..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
            <div class="input-footer"><span class="hint">â†µ Enter Â· Shift+â†µ Nova linha</span><button class="send-btn" id="sendBtn" onclick="sendMessage()">Gerar resposta â†—</button></div>
          </div>
        </div>
      </div>`;
  } else {
    sidebar.innerHTML=`
      <div><div class="side-title">Como usar</div>
      <div class="kb-text"><strong style="color:rgba(255,255,255,0.6)">1.</strong> Envie PDF/imagem do Reportei<br><br><strong style="color:rgba(255,255,255,0.6)">2.</strong> Informe nome do cliente<br><br><strong style="color:rgba(255,255,255,0.6)">3.</strong> Clique em Analisar</div>
      </div><hr class="divider">
      <div><div class="side-title">Tom da mensagem</div>
      <div class="kb-text">âœ… Positivos em destaque<br>âš¡ Negativos com plano de aÃ§Ã£o<br>ğŸ’œ Sempre proativo</div>
      </div>`;
    
    content.innerHTML=`
      <div class="chat-area">
        <div class="report-area" id="reportArea">
          <div class="upload-card" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-title">Envie o relatÃ³rio do Reportei</div>
            <div class="upload-sub">Clique para selecionar PDF ou imagem</div>
            <input type="file" id="fileInput" accept=".pdf,image/*" style="display:none" onchange="handleFile(this.files[0])">
          </div>
          <div id="filePreview" class="hidden"></div>
          <div class="context-row">
            <input class="context-input" id="reportClient" placeholder="Nome do cliente" style="max-width:200px">
            <input class="context-input" id="reportContext" placeholder="Contexto adicional (opcional)">
            <button class="analyze-btn" id="analyzeBtn" onclick="analyzeReport()" disabled>Analisar â†—</button>
          </div>
          <div id="reportResult"></div>
        </div>
      </div>`;
  }
}

function setTone(t,el){tone=t;document.querySelectorAll('.tone-btn').forEach(e=>e.classList.remove('active'));el.classList.add('active')}
function sendQuick(txt){document.getElementById('userInput').value=txt;sendMessage()}

async function sendMessage(){
  if(loading)return;
  const input=document.getElementById('userInput'),clientName=document.getElementById('clientName').value.trim(),text=input.value.trim();
  if(!text)return;
  input.value='';
  addUserMsg(text);
  loading=true;
  document.getElementById('sendBtn').disabled=true;
  showTyping();
  try{
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:getCSPrompt(),messages:[{role:'user',content:`${clientName?'Cliente: '+clientName+'\n':''}SituaÃ§Ã£o: ${text}\nTom: ${tone}`}],max_tokens:1500})});
    const data=await res.json();
    removeTyping();
    if(!res.ok){
      console.error('API Error:',res.status,data);
      addErrorMsg(`Erro ao gerar resposta (${res.status}). Veja console.`);
      return;
    }
    const raw=data.content.filter(b=>b.type==='text').map(b=>b.text).join('');
    let cleanRaw=raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    const jsonMatch=cleanRaw.match(/\{[\s\S]*\}/);
    if(jsonMatch){cleanRaw=jsonMatch[0]}
    let parsed;
    try{
      parsed=JSON.parse(cleanRaw);
      if(!parsed.clientMsg){parsed={tag:'Geral',internal:'Verifique.',clientMsg:cleanRaw}}
    }catch(e){
      console.error('Parse error:',e,cleanRaw);
      parsed={tag:'Geral',internal:'NÃ£o foi possÃ­vel processar.',clientMsg:cleanRaw}
    }
    addAssistantMsg(parsed)
  }catch(e){
    console.error('Request error:',e);
    removeTyping();
    addErrorMsg('Erro de conexÃ£o: '+e.message);
  }finally{loading=false;document.getElementById('sendBtn').disabled=false}
}

function addUserMsg(txt){const c=document.getElementById('msgs'),d=document.createElement('div');d.className='msg-row user';d.innerHTML=`<div class="avatar">CS</div><div class="msg-content"><div class="msg-label" style="text-align:right">Equipe CS</div><div class="user-bubble">${esc(txt)}</div></div>`;c.appendChild(d);c.scrollTop=c.scrollHeight}

function addAssistantMsg(m){
  const c=document.getElementById('msgs'),id='m'+Date.now(),d=document.createElement('div');
  d.className='msg-row';
  d.innerHTML=`<div class="avatar">ğŸ¦«</div><div class="response-wrap"><div class="msg-label">Assistente</div>${m.tag&&m.tag!=='Resposta'&&m.tag!=='Geral'?'<div style="font-size:10px;color:var(--beaver);margin-bottom:4px;font-weight:600">ğŸ“Œ '+esc(m.tag)+'</div>':''}${m.internal&&m.internal!=='Verifique.'&&m.internal!=='NÃ£o foi possÃ­vel processar.'?'<div class="block-internal"><div class="block-label amber">âš™ï¸ OrientaÃ§Ã£o interna</div><div>'+esc(m.internal)+'</div></div>':''}<div class="block-msg"><div class="block-label beaver">ğŸ’¬ Mensagem cliente</div><div class="block-msg-text" id="${id}">${esc(m.clientMsg)}</div></div><div class="actions-row"><button class="copy-btn" onclick="copy('${id}',this)">ğŸ“‹ Copiar</button></div></div>`;
  c.appendChild(d);
  c.scrollTop=c.scrollHeight;
}

function addErrorMsg(txt){const c=document.getElementById('msgs'),d=document.createElement('div');d.className='msg-row';d.innerHTML=`<div class="avatar">ğŸ¦«</div><div class="msg-content"><div class="msg-label">Assistente</div><div class="error-bubble">${txt}</div></div>`;c.appendChild(d);c.scrollTop=c.scrollHeight}

function showTyping(){const c=document.getElementById('msgs'),d=document.createElement('div');d.className='msg-row';d.id='typing';d.innerHTML='<div class="avatar">ğŸ¦«</div><div class="typing-dots"><span></span><span></span><span></span></div>';c.appendChild(d);c.scrollTop=c.scrollHeight}
function removeTyping(){const e=document.getElementById('typing');if(e)e.remove()}

function handleFile(file){reportFile=file;if(!file)return;document.querySelector('.upload-card').classList.add('hidden');const preview=document.getElementById('filePreview');preview.className='file-preview';preview.innerHTML=`<span style="font-size:22px">${file.type==='application/pdf'?'ğŸ“„':'ğŸ–¼ï¸'}</span><div style="flex:1"><div class="file-name">${file.name}</div><div style="font-size:11px;color:rgba(26,16,37,0.4)">${(file.size/1024).toFixed(0)} KB</div></div><button class="remove-btn" onclick="clearFile()">Remover</button>`;document.getElementById('analyzeBtn').disabled=false}

function clearFile(){reportFile=null;document.querySelector('.upload-card').classList.remove('hidden');document.getElementById('filePreview').className='hidden';document.getElementById('filePreview').innerHTML='';document.getElementById('analyzeBtn').disabled=true;document.getElementById('reportResult').innerHTML=''}

async function analyzeReport(){
  if(!reportFile||loading)return;
  loading=true;
  document.getElementById('analyzeBtn').disabled=true;
  document.getElementById('reportResult').innerHTML='<div class="msg-row"><div class="avatar">ğŸ¦«</div><div class="typing-dots"><span></span><span></span><span></span></div></div>';
  
  try{
    const base64=await toBase64(reportFile);
    const isPdf=reportFile.type==='application/pdf';
    const clientName=document.getElementById('reportClient').value.trim();
    const context=document.getElementById('reportContext').value.trim();
    
    const userContent=[
      {type:isPdf?'document':'image',source:{type:'base64',media_type:reportFile.type,data:base64}},
      {type:'text',text:`${clientName?'Cliente: '+clientName+'\n':''}${context?'Contexto: '+context:'Analise este relatÃ³rio.'}`}
    ];
    
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:getReportPrompt(),messages:[{role:'user',content:userContent}],max_tokens:1500})});
    const data=await res.json();
    
    if(!res.ok){
      console.error('API Error:',res.status,data);
      document.getElementById('reportResult').innerHTML=`<div class="error-bubble">Erro ao analisar (${res.status}). Veja console para detalhes.</div>`;
      return;
    }
    
    const raw=data.content.filter(b=>b.type==='text').map(b=>b.text).join('');
    let parsed;
    try{
      parsed=JSON.parse(raw.replace(/```json|```/gm,'').trim());
    }catch(e){
      console.error('Parse error:',e,raw);
      document.getElementById('reportResult').innerHTML='<div class="error-bubble">Erro ao processar JSON. Veja console.</div>';
      return;
    }
    
    const rid='r'+Date.now();
    document.getElementById('reportResult').innerHTML=`
      <div class="response-wrap" style="max-width:100%">
        ${parsed.internal?'<div class="block-internal"><div class="block-label amber">âš™ï¸ AnÃ¡lise para a CS</div><div>'+esc(parsed.internal)+'</div></div>':''}
        <div class="block-msg"><div class="block-label beaver">ğŸ’¬ Mensagem para o cliente</div><div class="block-msg-text" id="${rid}">${esc(parsed.clientMsg)}</div></div>
        <div class="actions-row"><button class="copy-btn" onclick="copy('${rid}',this)">ğŸ“‹ Copiar</button></div>
      </div>`;
  }catch(e){
    console.error('Request error:',e);
    document.getElementById('reportResult').innerHTML='<div class="error-bubble">Erro de conexÃ£o: '+e.message+'</div>';
  }finally{loading=false;document.getElementById('analyzeBtn').disabled=false}
}

function toBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file)})}

function copy(id,btn){const el=document.getElementById(id);if(!el)return;navigator.clipboard.writeText(el.innerText.trim()).then(()=>{btn.classList.add('copied');btn.textContent='âœ“ Copiado!';setTimeout(()=>{btn.classList.remove('copied');btn.innerHTML='ğŸ“‹ Copiar'},2000)})}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function getCSPrompt(){return`Assistente Beaver CS. JSON puro: {"tag":"Cat","internal":"Orient CS","clientMsg":"Msg cliente"}

PERFIL: Profissional, estratÃ©gico, proativo, consultivo, seguro.
NUNCA: Delegar anÃ¡lise, sugerir call, improviso.

ğŸ“Š ANÃLISE RELATÃ“RIOS (auto-detecta mÃ©tricas):
GLOSSÃRIO: CTRâ†’"interesse" | CPCâ†’"clique barato" | Taxa conversÃ£oâ†’"visitantesâ†’leads" | CPLâ†’custo/lead

ğŸš« TRAVAS:
1.VOCABULÃRIO: âŒ"fantÃ¡sticos","arrasando",ğŸš€ âœ…"Ã³timos","sÃ³lida","destaque" ğŸ’œ(sÃ³ fim)
2.PRECISÃƒO: âŒROI/ROAS/faturamento(se nÃ£o houver) âœ…CPL,CPA,impressÃµes,cliques,CTR
3.ORÃ‡AMENTO: âŒ"aumentar verba" âœ…"realocar Xâ†’Y","otimizar mix"

PROIBIDO: "caiu","piorou" | USE: "ajustando","otimizando"
NEGATIVOS: Reconhece+Contexto+EficiÃªncia+AÃ§Ã£o
ESTRUTURA: O QUE+POR QUE+SIGNIFICA+VAMOS FAZER

ğŸ”´ NUNCA DELEGUE: âŒ"VocÃª envia" âœ…"Vou analisar internamente"
âš ï¸ APROVAÃ‡ÃƒO: Sempre insista "conferÃªncia rÃ¡pida"
ğŸ¯ PRAZOS: Negocie se irreal
ğŸš« CALL: SÃ“ se pedir

EXPRESSÃ•ES: "Tudo bem?"|"Combinado."|"Perfeito."|"Conte comigo."|"Vou analisar internamente..."

TOM: Cordial|Objetivo|Formal leve|Consultivo|Profissional

EMOJIS: ğŸ™‚ğŸ˜ŠğŸ’œğŸ‘ | PROIBIDO:ğŸš€

ESTRUTURA: 1.SaudaÃ§Ã£o 2.ValidaÃ§Ã£o 3.ExplicaÃ§Ã£o/AÃ§Ã£o 4.PrÃ³ximos passos 5."Conte comigo.ğŸ’œ"

PROCEDIMENTOS: iClips:12h|OrÃ§amento:Ã—1.2Ã—1.33|GravaÃ§Ã£o:1dia antes

AGÃŠNCIA ANALISA. CLIENTE VALIDA.`}

function getReportPrompt(){return`Analista Beaver. JSON: {"internal":"AnÃ¡lise CS","clientMsg":"Msg cliente"}

ğŸš« TRAVAS:
1.VOCABULÃRIO: âŒ"fantÃ¡sticos","arrasando",ğŸš€ âœ…"Ã³timos","sÃ³lida","destaque" ğŸ’œ(sÃ³ fim)
2.PRECISÃƒO: âŒROI/ROAS/faturamento(nÃ£o houver) âœ…CPL,CPA,impressÃµes,cliques,CTR
3.ORÃ‡AMENTO: âŒ"aumentar verba" âœ…"realocar","redistribuir","otimizar"

REGRAS:
1.POSITIVOS:Destaque profissional,evoluÃ§Ã£o
2.NEGATIVOS:Proativo+plano
3.NUNCA:"queda","piora","problema"
4.USE:"oportunidade","otimizando","ajustando"
5.SEMPRE:PrÃ³ximos passos

ESTRUTURA:
1."OlÃ¡,[Nome]!Tudo bem?"
2.PerÃ­odo
3.Destaques POSITIVOS(profissional)
4.AtenÃ§Ã£o(construtivo):"Para otimizar,ajustando..."
5.PrÃ³ximos passos
6."Conte comigo.ğŸ’œ"

GLOSSÃRIO:CTRâ†’"interesse"|CPCâ†’"clique barato"|ConversÃ£oâ†’"visitantesâ†’leads"|CPLâ†’custo/lead

EXPRESSÃ•ES:"Tudo bem?"|"Perfeito."|"Seguimos"|"Conte comigo."|"Performance sÃ³lida"|"Ã“timos resultados"

JSON:{"periodo":"","destaques":[],"internal":"NÃºmeros,bem,atenÃ§Ã£o,benchmarks.SEM ROI/ROAS/faturamento se nÃ£o houver.SEM sugerir aumento verba.","clientMsg":"SaudaÃ§Ã£o+perÃ­odo+positivos PROFISSIONAL+atenÃ§Ã£o PROATIVO+prÃ³ximos+ğŸ’œ"}

OTIMIZA existente.`}

renderTab();
</script>
</body>
</html>
