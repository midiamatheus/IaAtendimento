<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beaver CS ¬∑ Assistente</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--beaver:#7B3FE4;--beaver-light:#9B6FF0;--beaver-dark:#5A2DB0;--cream:#FAF8F5;--ink:#1A1025;--ink-soft:#3D2E52;--mist:#EDE8F7;--mist-deep:#D9D0F0;--green:#2DCB85;--amber:#F0A500;--red:#E84040;--border:rgba(123,63,228,0.12)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--cream);height:100vh;display:flex;flex-direction:column;font-size:14px;overflow:hidden}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:var(--ink);border-bottom:2px solid var(--beaver)}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:30px;height:30px;background:var(--beaver);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:#fff}
.logo-text span{color:var(--beaver-light)}
.badge{display:flex;align-items:center;gap:6px;background:rgba(45,203,133,0.15);border:1px solid rgba(45,203,133,0.3);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:500;color:var(--green)}
.pulse{width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.tab-bar{display:flex;background:var(--ink);border-bottom:1px solid rgba(123,63,228,0.2);padding-left:24px;flex-shrink:0}
.tab{padding:10px 20px;font-size:12.5px;cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;transition:all .15s;border-bottom:2px solid transparent;color:rgba(255,255,255,0.45);font-weight:400}
.tab.active{font-weight:600;color:#fff;border-bottom-color:var(--beaver)}
.main{display:flex;flex:1;overflow:hidden;min-height:0}
aside{width:250px;background:var(--ink);border-right:1px solid rgba(123,63,228,0.2);display:flex;flex-direction:column;overflow-y:auto;padding:18px 13px;gap:16px;flex-shrink:0}
.side-title{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);padding-left:3px;margin-bottom:6px}
.quick-btn{width:100%;text-align:left;background:rgba(255,255,255,0.04);border:1px solid rgba(123,63,228,0.15);border-radius:9px;padding:9px 10px;color:rgba(255,255,255,0.72);font-family:'DM Sans',sans-serif;font-size:11.5px;cursor:pointer;line-height:1.4;margin-bottom:4px;display:flex;align-items:flex-start;gap:7px;transition:all .15s}
.quick-btn:hover{background:rgba(123,63,228,0.14);border-color:var(--beaver);color:#fff;transform:translateX(3px)}
.divider{border:none;border-top:1px solid rgba(255,255,255,0.06);margin:8px 0}
.tone-btn{display:flex;align-items:center;gap:7px;padding:7px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.07);background:transparent;cursor:pointer;color:rgba(255,255,255,0.55);font-size:11.5px;margin-bottom:4px;width:100%;text-align:left;font-family:'DM Sans',sans-serif;transition:all .15s}
.tone-btn.active{border-color:var(--beaver);background:rgba(123,63,228,0.15);color:#fff}
#content{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}
.chat-area{display:flex;flex-direction:column;height:100%;overflow:hidden}
.msgs{flex:1;overflow-y:scroll !important;overflow-x:hidden;padding:22px 26px;display:flex;flex-direction:column;gap:18px}
.welcome-card{background:linear-gradient(135deg,var(--beaver) 0%,var(--beaver-dark) 100%);border-radius:16px;padding:20px 24px;color:#fff}
.welcome-card h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:5px}
.welcome-card p{font-size:13px;opacity:.85;line-height:1.5}
.msg-row{display:flex;align-items:flex-start;gap:9px;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg-row.user{flex-direction:row-reverse}
.avatar{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;background:var(--beaver);color:#fff;font-weight:700;font-family:'Syne',sans-serif}
.user .avatar{background:var(--ink);font-size:10px}
.msg-content{max-width:65%;word-wrap:break-word;overflow-wrap:break-word}
.msg-label{font-size:9.5px;font-weight:600;letter-spacing:.5px;color:rgba(26,16,37,0.35);text-transform:uppercase;padding-left:2px;margin-bottom:3px}
.user-bubble{background:var(--beaver);border-radius:13px;border-top-right-radius:3px;padding:10px 14px;font-size:13.5px;line-height:1.6;color:#fff;word-wrap:break-word;overflow-wrap:break-word}
.response-wrap{display:flex;flex-direction:column;gap:7px;max-width:65%;word-wrap:break-word;overflow-wrap:break-word}
.block-internal{background:#fff;border:1px solid var(--border);border-left:3px solid var(--amber);border-radius:12px;border-top-left-radius:3px;padding:11px 14px;font-size:12.5px;line-height:1.6;color:var(--ink-soft);word-wrap:break-word;overflow-wrap:break-word}
.block-label{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:4px}
.block-label.amber{color:var(--amber)}
.block-label.beaver{color:var(--beaver)}
.block-msg{background:var(--mist);border:1.5px solid var(--beaver);border-radius:12px;border-top-left-radius:3px;padding:13px 15px;word-wrap:break-word;overflow-wrap:break-word}
.block-msg-text{white-space:pre-wrap;font-size:13.5px;line-height:1.65;color:var(--ink);border-left:3px solid var(--beaver-light);padding-left:11px;margin-top:2px;word-wrap:break-word;overflow-wrap:break-word}
.actions-row{display:flex;gap:5px;flex-wrap:wrap;margin-top:4px}
.copy-btn{background:none;border:1px solid var(--border);border-radius:7px;padding:3px 10px;font-size:10.5px;color:var(--beaver);cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:500;display:flex;align-items:center;gap:3px;transition:all .15s}
.copy-btn:hover{background:var(--mist);border-color:var(--beaver)}
.copy-btn.copied{background:rgba(45,203,133,0.08);border-color:var(--green);color:var(--green)}
.typing-dots{display:flex;gap:5px;padding:11px 14px;background:#fff;border:1px solid var(--border);border-radius:13px;border-top-left-radius:3px}
.typing-dots span{width:7px;height:7px;border-radius:50%;background:var(--beaver-light);animation:bounce 1.2s infinite}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
.input-area{padding:14px 26px 18px;border-top:1px solid var(--border);background:var(--cream);flex-shrink:0}
.input-wrapper{background:#fff;border:1.5px solid var(--border);border-radius:13px;display:flex;flex-direction:column;box-shadow:0 3px 16px rgba(123,63,228,0.07)}
.input-wrapper:focus-within{border-color:var(--beaver);box-shadow:0 3px 16px rgba(123,63,228,0.15)}
.input-meta{display:flex;align-items:center;gap:8px;padding:9px 13px 0}
.input-meta-label{font-size:10px;font-weight:600;color:rgba(26,16,37,0.35);text-transform:uppercase;letter-spacing:.8px}
.client-input{border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:12.5px;font-weight:500;color:var(--beaver);background:transparent;width:150px}
.textarea{border:none;outline:none;resize:none;font-family:'DM Sans',sans-serif;font-size:13.5px;line-height:1.6;color:var(--ink);padding:9px 13px;background:transparent;min-height:60px;max-height:130px}
.input-footer{display:flex;align-items:center;justify-content:space-between;padding:6px 12px 9px}
.hint{font-size:11px;color:rgba(26,16,37,0.27)}
.send-btn{background:var(--beaver);color:#fff;border:none;border-radius:9px;padding:8px 17px;font-family:'Syne',sans-serif;font-size:12.5px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s}
.send-btn:hover{background:var(--beaver-dark)}
.send-btn:disabled{opacity:.5;cursor:not-allowed}
.error-bubble{background:#fff;border:1px solid var(--border);border-left:3px solid var(--red);border-radius:13px;padding:11px 14px;font-size:13px;color:#c0392b;max-width:65%;word-wrap:break-word}
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-track{background:rgba(237,232,247,0.3)}
::-webkit-scrollbar-thumb{background:var(--mist-deep);border-radius:10px;border:2px solid var(--cream)}
::-webkit-scrollbar-thumb:hover{background:#C4B8E3}
textarea::placeholder,input::placeholder{color:rgba(26,16,37,0.28)}
.hidden{display:none!important}
</style>
</head>
<body>

<header>
<div class="logo">
<div class="logo-icon">ü¶´</div>
<div class="logo-text">Beaver <span>CS ¬∑ IA</span></div>
</div>
<div class="badge"><div class="pulse"></div>IA ativa</div>
</header>

<div class="tab-bar">
<button class="tab active">üí¨ Atendimento ao Cliente</button>
</div>

<div class="main">
<aside>
<div><div class="side-title">Atalhos r√°pidos</div>
<button class="quick-btn" onclick="sendQuick('O cliente quer saber o status de aprova√ß√£o no iClips.')"><span>üìã</span><span>Aprova√ß√£o pendente</span></button>
<button class="quick-btn" onclick="sendQuick('Confirmar grava√ß√£o amanh√£.')"><span>üé¨</span><span>Confirmar grava√ß√£o</span></button>
<button class="quick-btn" onclick="sendQuick('Cliente insatisfeito.')"><span>‚ö†Ô∏è</span><span>Gest√£o de crise</span></button>
<button class="quick-btn" onclick="sendQuick('Novo cliente assinou.')"><span>üöÄ</span><span>Onboarding</span></button>
<button class="quick-btn" onclick="sendQuick('Calcular or√ßamento: fornecedor R$ 800.')"><span>üí∞</span><span>Or√ßamento</span></button>
</div>
<hr class="divider">
<div><div class="side-title">Tom da resposta</div>
<button class="tone-btn active" onclick="setTone('padrao',this)">üíú Padr√£o Beaver</button>
<button class="tone-btn" onclick="setTone('formal',this)">üé© Formal</button>
<button class="tone-btn" onclick="setTone('direto',this)">‚ö° Direto</button>
</div>
</aside>

<div id="content">
<div class="chat-area">
<div class="msgs" id="msgs">
<div class="welcome-card"><h2>Ol√°, equipe Beaver! üíú</h2><p>Assistente seguindo a Persona Beaver oficial. Descrevo situa√ß√µes e gero orienta√ß√£o + mensagem no padr√£o da ag√™ncia.</p></div>
</div>
<div class="input-area">
<div class="input-wrapper">
<div class="input-meta"><span class="input-meta-label">Cliente:</span><input type="text" class="client-input" id="clientName" placeholder="Nome (opcional)"></div>
<textarea class="textarea" id="userInput" placeholder="Descreva a situa√ß√£o..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
<div class="input-footer"><span class="hint">‚Üµ Enter ¬∑ Shift+‚Üµ Nova linha</span><button class="send-btn" id="sendBtn" onclick="sendMessage()">Gerar resposta ‚Üó</button></div>
</div>
</div>
</div>
</div>
</div>

<script>
let tone='padrao',loading=false;

function setTone(t,el){tone=t;document.querySelectorAll('.tone-btn').forEach(e=>e.classList.remove('active'));el.classList.add('active')}
function sendQuick(txt){document.getElementById('userInput').value=txt;sendMessage()}

async function sendMessage(){
  if(loading)return;
  const input=document.getElementById('userInput'),clientName=document.getElementById('clientName').value.trim(),text=input.value.trim();
  if(!text)return;
  input.value='';
  addUserMsg(text);
  loading=true;
  document.getElementById('sendBtn').disabled=true;
  showTyping();
  
  try{
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:getCSPrompt(),messages:[{role:'user',content:`${clientName?'Cliente: '+clientName+'\n':''}Situa√ß√£o: ${text}\nTom: ${tone}`}],max_tokens:1500})});
    const data=await res.json();
    removeTyping();
    
    if(!res.ok){addErrorMsg('Erro ao gerar resposta.');return}
    
    const raw=data.content.filter(b=>b.type==='text').map(b=>b.text).join('');
    
    // Limpeza agressiva de markdown e busca de JSON
    let cleanRaw = raw
      .replace(/```json/gi, '')
      .replace(/```/g, '')
      .replace(/^\s*[\r\n]/gm, '')
      .trim();
    
    // Tenta extrair apenas o JSON se houver texto antes/depois
    const jsonMatch = cleanRaw.match(/\{[\s\S]*\}/);
    if(jsonMatch) {
      cleanRaw = jsonMatch[0];
    }
    
    let parsed;
    try{
      parsed = JSON.parse(cleanRaw);
      
      // Valida se tem os campos necess√°rios
      if(!parsed.clientMsg || typeof parsed.clientMsg !== 'string'){
        console.warn('JSON inv√°lido, usando fallback');
        parsed = {
          tag: 'Resposta',
          internal: 'Processamento com fallback.',
          clientMsg: cleanRaw
        };
      }
    }catch(e){
      console.error('Erro parse JSON:', e);
      console.log('Raw recebido:', raw);
      console.log('Clean tentado:', cleanRaw);
      
      // Fallback: usa o texto limpo diretamente
      parsed = {
        tag: 'Resposta',
        internal: 'N√£o foi poss√≠vel processar o JSON. Verifique o formato da resposta.',
        clientMsg: cleanRaw || 'Erro ao processar resposta.'
      };
    }
    
    addAssistantMsg(parsed);
    
  }catch(e){
    console.error('Erro requisi√ß√£o:', e);
    removeTyping();
    addErrorMsg('Erro de conex√£o.');
  }finally{
    loading=false;
    document.getElementById('sendBtn').disabled=false;
  }
}

function addUserMsg(txt){
  const c=document.getElementById('msgs'),d=document.createElement('div');
  d.className='msg-row user';
  d.innerHTML=`<div class="avatar">CS</div><div class="msg-content"><div class="msg-label" style="text-align:right">Equipe CS</div><div class="user-bubble">${esc(txt)}</div></div>`;
  c.appendChild(d);
  c.scrollTop=c.scrollHeight;
}

function addAssistantMsg(m){
  const c=document.getElementById('msgs'),id='m'+Date.now(),d=document.createElement('div');
  d.className='msg-row';
  
  let html = `<div class="avatar">ü¶´</div><div class="response-wrap"><div class="msg-label">Assistente</div>`;
  
  if(m.tag && m.tag !== 'Resposta' && m.tag !== 'Geral'){
    html += `<div style="font-size:10px;color:var(--beaver);margin-bottom:4px;font-weight:600">üìå ${esc(m.tag)}</div>`;
  }
  
  if(m.internal && m.internal !== 'Verifique.' && m.internal !== 'N√£o foi poss√≠vel processar.'){
    html += `<div class="block-internal"><div class="block-label amber">‚öôÔ∏è Orienta√ß√£o interna</div><div>${esc(m.internal)}</div></div>`;
  }
  
  html += `<div class="block-msg"><div class="block-label beaver">üí¨ Mensagem cliente</div><div class="block-msg-text" id="${id}">${esc(m.clientMsg)}</div></div>`;
  html += `<div class="actions-row"><button class="copy-btn" onclick="copy('${id}',this)">üìã Copiar</button></div></div>`;
  
  d.innerHTML = html;
  c.appendChild(d);
  c.scrollTop = c.scrollHeight;
}

function addErrorMsg(txt){
  const c=document.getElementById('msgs'),d=document.createElement('div');
  d.className='msg-row';
  d.innerHTML=`<div class="avatar">ü¶´</div><div class="msg-content"><div class="msg-label">Assistente</div><div class="error-bubble">${txt}</div></div>`;
  c.appendChild(d);
  c.scrollTop=c.scrollHeight;
}

function showTyping(){
  const c=document.getElementById('msgs'),d=document.createElement('div');
  d.className='msg-row';
  d.id='typing';
  d.innerHTML='<div class="avatar">ü¶´</div><div class="typing-dots"><span></span><span></span><span></span></div>';
  c.appendChild(d);
  c.scrollTop=c.scrollHeight;
}

function removeTyping(){
  const e=document.getElementById('typing');
  if(e)e.remove();
}

function copy(id,btn){
  const el=document.getElementById(id);
  if(!el)return;
  navigator.clipboard.writeText(el.innerText.trim()).then(()=>{
    btn.classList.add('copied');
    btn.textContent='‚úì Copiado!';
    setTimeout(()=>{
      btn.classList.remove('copied');
      btn.innerHTML='üìã Copiar';
    },2000);
  });
}

function esc(s){
  if(!s) return '';
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

function getCSPrompt(){
  return `Voc√™ √© o assistente da Ag√™ncia Beaver. Siga as Diretrizes da Persona Beaver.

CR√çTICO: Responda SOMENTE com JSON puro. Nada antes, nada depois. Sem \`\`\`json, sem markdown, sem explica√ß√µes.

Formato EXATO:
{"tag":"Categoria","internal":"Orienta√ß√£o para CS","clientMsg":"Mensagem para cliente"}

PERFIL: Profissional, estrat√©gico, organizado, proativo, cordial (sem excesso), seguro, consultivo, √°gil, transparente.
TRANSMITE: Controle, clareza, responsabilidade, disponibilidade, confian√ßa.
NUNCA: Improviso, inseguran√ßa, desorganiza√ß√£o, aceitar demandas cegas.

‚ö†Ô∏è PROTOCOLO DE SEGURAN√áA (INEGOCI√ÅVEL):
NUNCA aceite pular aprova√ß√£o, mesmo que o cliente pe√ßa. Voc√™ √© ORGANIZADO E ORIENTADO A PROCESSOS.
Se cliente pedir "publicar direto" ou "sem aprova√ß√£o":
- Agrade√ßa a confian√ßa
- Insista gentilmente em "confer√™ncia r√°pida" ou "dupla checagem"
- Explique que isso protege a marca dele
- Seguran√ßa t√©cnica > agilidade

Exemplo: "Agrade√ßo a confian√ßa! Para garantir que tudo esteja perfeito, vamos fazer uma confer√™ncia r√°pida antes. √â um procedimento de seguran√ßa da marca. Combinado?"

üéØ POSTURA CONSULTIVA (N√ÉO EXECUTOR):
NUNCA aceite demandas imposs√≠veis ou vagas sem questionar.
Se prazo irreal ou pedido vago:
- N√ÉO diga apenas "Sim"
- Use racioc√≠nio: analise viabilidade
- Negocie prazo realista OU
- Pe√ßa esclarecimentos
- Mostre que est√° pensando no melhor resultado

Exemplo prazo irreal: "Entendido. Para garantir a qualidade que voc√™ espera, o ideal seria [prazo realista]. Podemos ajustar? Ou prefere que priorizemos [parte espec√≠fica] para [prazo pedido]?"

Exemplo pedido vago: "Perfeito! Para direcionar bem, voc√™ prefere foco em [op√ß√£o A] ou [op√ß√£o B]? Assim garantimos que o resultado seja exatamente o que voc√™ imagina."

EXPRESS√ïES: "Tudo bem?" | "Combinado." | "Perfeito." | "Conte comigo." | "Estamos √† disposi√ß√£o." | "Vou verificar e j√° te retorno." | "Vamos ajustar." | "Podemos confirmar?" | "Alinhando internamente." | "Para garantir a qualidade..." | "O ideal seria..."

TOM: Cordial mas n√£o √≠ntimo | Objetivo mas n√£o seco | Formal leve | Frases curtas | Consultivo e estrat√©gico.

EMOJIS PERMITIDOS (moderado): üôÇ üòä üíú üëç

PROIBIDO:
‚ùå "Desculpa" ‚Üí USE: "Sentimos muito"
‚ùå Diminutivos: rapidinho, ajustezinho
‚ùå G√≠rias: top, massa, show, bora
‚ùå Defensivo: "Mas voc√™s n√£o..."
‚ùå Aceitar cegamente pedidos para pular processos
‚ùå Dizer "sim" para prazos imposs√≠veis sem negociar

ESTRUTURA mensagem cliente:
1. Sauda√ß√£o: "Ol√°, [Nome]! Tudo bem?"
2. Valida√ß√£o: "Recebido." / "Entendido."
3. A√ß√£o: "Vou alinhar internamente." OU Negocia√ß√£o consultiva se necess√°rio
4. Pr√≥ximo passo: "Assim que aprovado, programamos."
5. Disponibilidade: "Conte comigo."

PROCEDIMENTOS:
- iClips: Posts at√© 12h‚Üímesmo dia | Ap√≥s 12h‚Üípr√≥ximo dia | SEMPRE com aprova√ß√£o
- Or√ßamento: fornecedor√ó1.2√ó1.33 | Comiss√£o 15%
- Grava√ß√µes: confirmar 1 dia antes | Toler√¢ncia 15min
- Crise: L√≠der‚ÜíEmail‚ÜíPlano‚Üí30 dias
- Aprova√ß√£o: NUNCA pule, sempre insista gentilmente

RACIOC√çNIO (use sempre):
1. √â vi√°vel? 2. Falta informa√ß√£o? 3. Prazo realista? 4. Protege a marca? 5. Mant√©m qualidade?

Voc√™ √© PARCEIRO ESTRAT√âGICO, n√£o executor obediente. Pense no melhor para o cliente, mesmo que ele n√£o saiba o que pedir.

LEMBRE-SE: Responda APENAS o JSON. Nada mais.`;
}
</script>
</body>
</html>
