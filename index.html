<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beaver CS ¬∑ Assistente</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--beaver:#7B3FE4;--beaver-light:#9B6FF0;--beaver-dark:#5A2DB0;--cream:#FAF8F5;--ink:#1A1025;--ink-soft:#3D2E52;--mist:#EDE8F7;--mist-deep:#D9D0F0;--green:#2DCB85;--amber:#F0A500;--red:#E84040;--border:rgba(123,63,228,0.12)}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--cream);height:100vh;display:flex;flex-direction:column;font-size:14px;overflow:hidden}header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:var(--ink);border-bottom:2px solid var(--beaver)}.logo{display:flex;align-items:center;gap:10px}.logo-icon{width:30px;height:30px;background:var(--beaver);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:#fff}.logo-text span{color:var(--beaver-light)}.badge{display:flex;align-items:center;gap:6px;background:rgba(45,203,133,0.15);border:1px solid rgba(45,203,133,0.3);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:500;color:var(--green)}.pulse{width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}.tab-bar{display:flex;background:var(--ink);border-bottom:1px solid rgba(123,63,228,0.2);padding-left:24px;flex-shrink:0}.tab{padding:10px 20px;font-size:12.5px;cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;transition:all .15s;border-bottom:2px solid transparent;color:rgba(255,255,255,0.45);font-weight:400}.tab.active{font-weight:600;color:#fff;border-bottom-color:var(--beaver)}.main{display:grid;grid-template-columns:250px 1fr;flex:1;overflow:hidden;min-height:0}aside{background:var(--ink);border-right:1px solid rgba(123,63,228,0.2);display:flex;flex-direction:column;overflow-y:auto;padding:18px 13px;gap:16px}.side-title{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);padding-left:3px;margin-bottom:6px}.quick-btn{width:100%;text-align:left;background:rgba(255,255,255,0.04);border:1px solid rgba(123,63,228,0.15);border-radius:9px;padding:9px 10px;color:rgba(255,255,255,0.72);font-family:'DM Sans',sans-serif;font-size:11.5px;cursor:pointer;line-height:1.4;margin-bottom:4px;display:flex;align-items:flex-start;gap:7px;transition:all .15s}.quick-btn:hover{background:rgba(123,63,228,0.14);border-color:var(--beaver);color:#fff;transform:translateX(3px)}.divider{border:none;borderTop:1px solid rgba(255,255,255,0.06);margin:0}.tone-btn{display:flex;align-items:center;gap:7px;padding:7px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.07);background:transparent;cursor:pointer;color:rgba(255,255,255,0.55);font-size:11.5px;margin-bottom:4px;width:100%;text-align:left;font-family:'DM Sans',sans-serif;transition:all .15s}.tone-btn.active{border-color:var(--beaver);background:rgba(123,63,228,0.15);color:#fff}.kb-text{font-size:11px;color:rgba(255,255,255,0.38);line-height:1.8;padding-left:3px}.chat-area{display:flex;flex-direction:column;height:100%;min-height:0;overflow:hidden}.msgs{flex:1;overflow-y:auto;overflow-x:hidden;padding:22px 26px;display:flex;flex-direction:column;gap:18px}.welcome-card{background:linear-gradient(135deg,var(--beaver) 0%,var(--beaver-dark) 100%);border-radius:16px;padding:20px 24px;color:#fff}.welcome-card h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:5px}.welcome-card p{font-size:13px;opacity:.85;line-height:1.5}.msg-row{display:flex;align-items:flex-start;gap:9px;animation:fadeUp .3s ease}@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.msg-row.user{flex-direction:row-reverse}.avatar{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;background:var(--beaver);color:#fff;font-weight:700;font-family:'Syne',sans-serif}.user .avatar{background:var(--ink);font-size:10px}.msg-content{max-width:68%;word-wrap:break-word}.msg-label{font-size:9.5px;font-weight:600;letter-spacing:.5px;color:rgba(26,16,37,0.35);text-transform:uppercase;padding-left:2px;margin-bottom:3px}.user-bubble{background:var(--beaver);border-radius:13px;border-top-right-radius:3px;padding:10px 14px;font-size:13.5px;line-height:1.6;color:#fff;word-wrap:break-word}.response-wrap{display:flex;flex-direction:column;gap:7px;max-width:68%;word-wrap:break-word}.block-internal{background:#fff;border:1px solid var(--border);border-left:3px solid var(--amber);border-radius:12px;border-top-left-radius:3px;padding:11px 14px;font-size:12.5px;line-height:1.6;color:var(--ink-soft);word-wrap:break-word}.block-label{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:4px}.block-label.amber{color:var(--amber)}.block-label.beaver{color:var(--beaver)}.block-msg{background:var(--mist);border:1.5px solid var(--beaver);border-radius:12px;border-top-left-radius:3px;padding:13px 15px;word-wrap:break-word}.block-msg-text{white-space:pre-wrap;font-size:13.5px;line-height:1.65;color:var(--ink);border-left:3px solid var(--beaver-light);padding-left:11px;margin-top:2px;word-wrap:break-word;overflow-wrap:break-word}.actions-row{display:flex;gap:5px;flex-wrap:wrap;margin-top:4px}.copy-btn{background:none;border:1px solid var(--border);border-radius:7px;padding:3px 10px;font-size:10.5px;color:var(--beaver);cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:500;display:flex;align-items:center;gap:3px;transition:all .15s}.copy-btn:hover{background:var(--mist);border-color:var(--beaver)}.copy-btn.copied{background:rgba(45,203,133,0.08);border-color:var(--green);color:var(--green)}.typing-dots{display:flex;gap:5px;padding:11px 14px;background:#fff;border:1px solid var(--border);border-radius:13px;border-top-left-radius:3px}.typing-dots span{width:7px;height:7px;border-radius:50%;background:var(--beaver-light);animation:bounce 1.2s infinite}@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}.typing-dots span:nth-child(2){animation-delay:.2s}.typing-dots span:nth-child(3){animation-delay:.4s}.input-area{padding:14px 26px 18px;border-top:1px solid var(--border);background:var(--cream);flex-shrink:0}.input-wrapper{background:#fff;border:1.5px solid var(--border);border-radius:13px;display:flex;flex-direction:column;box-shadow:0 3px 16px rgba(123,63,228,0.07)}.input-wrapper:focus-within{border-color:var(--beaver);box-shadow:0 3px 16px rgba(123,63,228,0.15)}.input-meta{display:flex;align-items:center;gap:8px;padding:9px 13px 0}.input-meta-label{font-size:10px;font-weight:600;color:rgba(26,16,37,0.35);text-transform:uppercase;letter-spacing:.8px}.client-input{border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:12.5px;font-weight:500;color:var(--beaver);background:transparent;width:150px}.textarea{border:none;outline:none;resize:none;font-family:'DM Sans',sans-serif;font-size:13.5px;line-height:1.6;color:var(--ink);padding:9px 13px;background:transparent;min-height:60px;max-height:130px}.input-footer{display:flex;align-items:center;justify-content:space-between;padding:6px 12px 9px}.hint{font-size:11px;color:rgba(26,16,37,0.27)}.send-btn{background:var(--beaver);color:#fff;border:none;border-radius:9px;padding:8px 17px;font-family:'Syne',sans-serif;font-size:12.5px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s}.send-btn:hover{background:var(--beaver-dark)}.send-btn:disabled{opacity:.5;cursor:not-allowed}.error-bubble{background:#fff;border:1px solid var(--border);border-left:3px solid var(--red);border-radius:13px;padding:11px 14px;font-size:13px;color:#c0392b;max-width:65%;word-wrap:break-word}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--mist-deep);border-radius:10px}::-webkit-scrollbar-thumb:hover{background:#C4B8E3}textarea::placeholder,input::placeholder{color:rgba(26,16,37,0.28)}.hidden{display:none!important}
</style>
</head>
<body>

<header>
<div class="logo">
<div class="logo-icon">ü¶´</div>
<div class="logo-text">Beaver <span>CS ¬∑ IA</span></div>
</div>
<div class="badge"><div class="pulse"></div>IA ativa</div>
</header>

<div class="tab-bar">
<button class="tab active" onclick="switchTab('cs')">üí¨ Atendimento ao Cliente</button>
</div>

<div class="main">
<aside id="sidebar"></aside>
<div id="content"></div>
</div>

<script>
let activeTab='cs',tone='padrao',loading=false;

function switchTab(tab){activeTab=tab;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));event.target.classList.add('active');renderTab()}

function renderTab(){
  const sidebar=document.getElementById('sidebar');
  const content=document.getElementById('content');
  
  sidebar.innerHTML=`
    <div><div class="side-title">Atalhos r√°pidos</div>
    <button class="quick-btn" onclick="sendQuick('O cliente quer saber o status de aprova√ß√£o no iClips.')"><span>üìã</span><span>Aprova√ß√£o pendente</span></button>
    <button class="quick-btn" onclick="sendQuick('Confirmar grava√ß√£o amanh√£.')"><span>üé¨</span><span>Confirmar grava√ß√£o</span></button>
    <button class="quick-btn" onclick="sendQuick('Cliente insatisfeito.')"><span>‚ö†Ô∏è</span><span>Gest√£o de crise</span></button>
    <button class="quick-btn" onclick="sendQuick('Novo cliente assinou.')"><span>üöÄ</span><span>Onboarding</span></button>
    <button class="quick-btn" onclick="sendQuick('Calcular or√ßamento: fornecedor R$ 800.')"><span>üí∞</span><span>Or√ßamento</span></button>
    </div><hr class="divider">
    <div><div class="side-title">Tom da resposta</div>
    <button class="tone-btn active" onclick="setTone('padrao',this)">üíú Padr√£o Beaver</button>
    <button class="tone-btn" onclick="setTone('formal',this)">üé© Formal</button>
    <button class="tone-btn" onclick="setTone('direto',this)">‚ö° Direto</button>
    </div>`;
  
  content.innerHTML=`
    <div class="chat-area">
      <div class="msgs" id="msgs">
        <div class="welcome-card"><h2>Ol√°, equipe Beaver! üíú</h2><p>Assistente seguindo a Persona Beaver oficial. Descrevo situa√ß√µes e gero orienta√ß√£o + mensagem no padr√£o da ag√™ncia.</p></div>
      </div>
      <div class="input-area">
        <div class="input-wrapper">
          <div class="input-meta"><span class="input-meta-label">Cliente:</span><input type="text" class="client-input" id="clientName" placeholder="Nome (opcional)"></div>
          <textarea class="textarea" id="userInput" placeholder="Descreva a situa√ß√£o..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
          <div class="input-footer"><span class="hint">‚Üµ Enter ¬∑ Shift+‚Üµ Nova linha</span><button class="send-btn" id="sendBtn" onclick="sendMessage()">Gerar resposta ‚Üó</button></div>
        </div>
      </div>
    </div>`;
}

function setTone(t,el){tone=t;document.querySelectorAll('.tone-btn').forEach(e=>e.classList.remove('active'));el.classList.add('active')}
function sendQuick(txt){document.getElementById('userInput').value=txt;sendMessage()}

async function sendMessage(){
  if(loading)return;
  const input=document.getElementById('userInput'),clientName=document.getElementById('clientName').value.trim(),text=input.value.trim();
  if(!text)return;
  input.value='';
  addUserMsg(text);
  loading=true;
  document.getElementById('sendBtn').disabled=true;
  showTyping();
  try{
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:getCSPrompt(),messages:[{role:'user',content:`${clientName?'Cliente: '+clientName+'\n':''}Situa√ß√£o: ${text}\nTom: ${tone}`}],max_tokens:1500})});
    const data=await res.json();
    removeTyping();
    if(!res.ok){addErrorMsg('Erro ao gerar resposta.');return}
    const raw=data.content.filter(b=>b.type==='text').map(b=>b.text).join('');
    let cleanRaw=raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    let parsed;
    try{
      parsed=JSON.parse(cleanRaw);
      if(!parsed.clientMsg){parsed={tag:'Geral',internal:'Verifique.',clientMsg:cleanRaw}}
    }catch(e){
      console.error('Parse error:',e,cleanRaw);
      parsed={tag:'Geral',internal:'N√£o foi poss√≠vel processar.',clientMsg:cleanRaw}
    }
    addAssistantMsg(parsed)
  }catch(e){removeTyping();addErrorMsg('Erro de conex√£o.')}finally{loading=false;document.getElementById('sendBtn').disabled=false}
}

function addUserMsg(txt){const c=document.getElementById('msgs'),d=document.createElement('div');d.className='msg-row user';d.innerHTML=`<div class="avatar">CS</div><div class="msg-content"><div class="msg-label" style="text-align:right">Equipe CS</div><div class="user-bubble">${esc(txt)}</div></div>`;c.appendChild(d);c.scrollTop=c.scrollHeight}

function addAssistantMsg(m){
  const c=document.getElementById('msgs'),id='m'+Date.now(),d=document.createElement('div');
  d.className='msg-row';
  d.innerHTML=`<div class="avatar">ü¶´</div><div class="response-wrap"><div class="msg-label">Assistente</div>${m.tag?'<div style="font-size:10px;color:var(--beaver);margin-bottom:4px">üìå '+esc(m.tag)+'</div>':''}${m.internal?'<div class="block-internal"><div class="block-label amber">‚öôÔ∏è Orienta√ß√£o interna</div><div>'+esc(m.internal)+'</div></div>':''}< div class="block-msg"><div class="block-label beaver">üí¨ Mensagem cliente</div><div class="block-msg-text" id="${id}">${esc(m.clientMsg)}</div></div><div class="actions-row"><button class="copy-btn" onclick="copy('${id}',this)">üìã Copiar</button></div></div>`;
  c.appendChild(d);
  c.scrollTop=c.scrollHeight;
}

function addErrorMsg(txt){const c=document.getElementById('msgs'),d=document.createElement('div');d.className='msg-row';d.innerHTML=`<div class="avatar">ü¶´</div><div class="msg-content"><div class="msg-label">Assistente</div><div class="error-bubble">${txt}</div></div>`;c.appendChild(d);c.scrollTop=c.scrollHeight}

function showTyping(){const c=document.getElementById('msgs'),d=document.createElement('div');d.className='msg-row';d.id='typing';d.innerHTML='<div class="avatar">ü¶´</div><div class="typing-dots"><span></span><span></span><span></span></div>';c.appendChild(d);c.scrollTop=c.scrollHeight}
function removeTyping(){const e=document.getElementById('typing');if(e)e.remove()}

function copy(id,btn){const el=document.getElementById(id);if(!el)return;navigator.clipboard.writeText(el.innerText.trim()).then(()=>{btn.classList.add('copied');btn.textContent='‚úì Copiado!';setTimeout(()=>{btn.classList.remove('copied');btn.innerHTML='üìã Copiar'},2000)})}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function getCSPrompt(){return`Voc√™ √© o assistente da Ag√™ncia Beaver. Siga TODAS as Diretrizes da Persona Beaver.

RESPONDA APENAS COM JSON PURO - SEM MARKDOWN, SEM TEXTO ANTES OU DEPOIS:
{"tag":"Categoria","internal":"Orienta√ß√£o CS","clientMsg":"Mensagem cliente"}

PERFIL: Profissional, estrat√©gico, organizado, proativo, cordial (sem excesso), seguro, consultivo, √°gil, transparente.
TRANSMITE: Controle, clareza, responsabilidade, disponibilidade, confian√ßa.
NUNCA: Improviso, inseguran√ßa, desorganiza√ß√£o.

EXPRESS√ïES OBRIGAT√ìRIAS: "Tudo bem?" | "Combinado." | "Perfeito." | "Conte comigo." | "Contem com a gente." | "Estamos √† disposi√ß√£o." | "Vou verificar e j√° te retorno." | "Segue para aprova√ß√£o." | "Vamos ajustar." | "Podemos confirmar?" | "Alinhando internamente." | "Seguimos com..."

TOM: Cordial mas n√£o √≠ntimo | Objetivo mas n√£o seco | Formal leve | Frases curtas.

EMOJIS PERMITIDOS (moderado): üôÇ üòä üíú üëç
NUNCA: Exagerados, sequ√™ncias longas, infantis, "kkkk"

PROIBIDO:
‚ùå "Desculpa" ‚Üí USE: "Sentimos muito pelo transtorno"
‚ùå Diminutivos: rapidinho, ajustezinho, coisinha
‚ùå G√≠rias: top, massa, show, bora
‚ùå Defensivo: "Mas voc√™s n√£o...", "Como j√° falamos..."

ESTRUTURA:
1. Sauda√ß√£o: "Ol√°, [Nome]! Tudo bem?"
2. Valida√ß√£o: "Recebido." / "Entendido."
3. A√ß√£o: "Vou alinhar internamente."
4. Pr√≥ximo passo: "Assim que aprovado, programamos."
5. Disponibilidade: "Conte comigo." / "Estamos √† disposi√ß√£o."

PROCEDIMENTOS:
- Tempo resposta: 5 min
- iClips: Posts at√© 12h‚Üímesmo dia | Ap√≥s 12h‚Üípr√≥ximo dia
- Or√ßamento: fornecedor√ó1.2√ó1.33 | Comiss√£o 15%
- Grava√ß√µes: confirmar 1 dia antes
- Crise: L√≠der‚ÜíEmail "Gest√£o Crise|Cliente"‚ÜíPlano‚Üí30 dias

SEMPRE: Prazos | Status | Parceria | Controle conversa

Voc√™ √© PARCEIRO, n√£o fornecedor.`}

renderTab();
</script>
</body>
</html>
